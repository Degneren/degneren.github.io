<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Intercom JWT Test</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 40px auto;
      padding: 0 20px;
      background: #f9f9f9;
      color: #333;
    }
    h1 { font-size: 1.4rem; margin-bottom: 4px; }
    p.subtitle { color: #666; font-size: 0.9rem; margin-top: 0; }
    .warning {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 10px 14px;
      font-size: 0.85rem;
      margin-bottom: 24px;
      border-radius: 4px;
    }
    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
      margin-top: 16px;
    }
    input[type="text"], input[type="email"] {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    .buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    button {
      flex: 1;
      padding: 12px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    button:hover { opacity: 0.85; }
    #btn-free { background: #e0e0e0; color: #333; }
    #btn-pro  { background: #4f46e5; color: #fff; }
    #btn-restart { background: #eee; color: #555; font-size: 0.85rem; padding: 8px; flex: none; width: auto; margin-top: 10px; border-radius: 6px; cursor: pointer; border: 1px solid #ccc; }
    .jwt-output {
      margin-top: 24px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 14px;
      display: none;
    }
    .jwt-output h3 { margin: 0 0 8px; font-size: 0.9rem; color: #555; }
    .jwt-output .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .badge.free { background: #e0e0e0; color: #555; }
    .badge.pro  { background: #4f46e5; color: #fff; }
    .jwt-token {
      font-family: monospace;
      font-size: 0.72rem;
      word-break: break-all;
      background: #f4f4f4;
      padding: 8px;
      border-radius: 4px;
      color: #333;
    }
    .status {
      margin-top: 10px;
      font-size: 0.85rem;
      color: #28a745;
      font-weight: 600;
    }
    .status.error { color: #dc3545; }
  </style>
</head>
<body>

  <h1>Intercom JWT Test Page</h1>
  <p class="subtitle">Test Intercom identity verification using a client-side generated JWT.</p>

  <div class="warning">
    ⚠️ <strong>Test only.</strong> The JWT secret is visible in the browser. Never expose your real secret in client-side code in production.
  </div>

  <label for="input-userid">User ID</label>
  <input type="text" id="input-userid" placeholder="e.g. test_user_123" value="test_user_123">

  <label for="input-email">Email (optional)</label>
  <input type="email" id="input-email" placeholder="e.g. test@example.com">

  <label for="input-secret">JWT Secret (Identity Verification Secret)</label>
  <input type="text" id="input-secret" placeholder="Paste your Intercom Identity Verification secret here">

  <div class="buttons">
    <button id="btn-free" onclick="initIntercomWithPlan('free')">Free Plan</button>
    <button id="btn-pro"  onclick="initIntercomWithPlan('pro')">Pro Plan</button>
  </div>

  <div style="margin-top: 10px;">
    <button id="btn-restart" onclick="restartIntercom()">Restart Intercom conversation</button>
  </div>

  <div class="jwt-output" id="jwt-output">
    <span class="badge" id="plan-badge"></span>
    <h3 style="margin-top:10px;">JWT (full token — for inspection)</h3>
    <div class="jwt-token" id="jwt-display"></div>
    <h3 style="margin-top:12px;">user_hash (HMAC-SHA256 hex — sent to Intercom)</h3>
    <div class="jwt-token" id="hash-display"></div>
    <div class="status" id="status-msg"></div>
  </div>

  <script>
    // Clear any stale Intercom session data from previous pages to prevent 404s on conversation load
    (function () {
      document.cookie = 'intercom-id-j3ouceg3=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
      for (var key in localStorage) {
        if (key.toLowerCase().indexOf('intercom') !== -1) {
          localStorage.removeItem(key);
        }
      }
    })();
  </script>

  <script>
    // Generate a full HS256 JWT (for display/inspection)
    async function generateJWT(secret, payload) {
      function base64url(input) {
        return btoa(input)
          .replace(/=/g, '')
          .replace(/\+/g, '-')
          .replace(/\//g, '_');
      }
      const header = base64url(JSON.stringify({ alg: 'HS256', typ: 'JWT' }));
      const body   = base64url(unescape(encodeURIComponent(JSON.stringify(payload))));
      const data   = `${header}.${body}`;
      const encoder = new TextEncoder();
      const key = await crypto.subtle.importKey(
        'raw', encoder.encode(secret),
        { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
      );
      const sig = await crypto.subtle.sign('HMAC', key, encoder.encode(data));
      const sigB64 = btoa(String.fromCharCode(...new Uint8Array(sig)))
        .replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
      return `${data}.${sigB64}`;
    }

    // Generate the HMAC-SHA256 hex hash Intercom expects as user_hash
    async function generateUserHash(secret, userId) {
      const encoder = new TextEncoder();
      const key = await crypto.subtle.importKey(
        'raw', encoder.encode(secret),
        { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
      );
      const sig = await crypto.subtle.sign('HMAC', key, encoder.encode(userId));
      return Array.from(new Uint8Array(sig))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    async function initIntercomWithPlan(plan) {
      const userId = document.getElementById('input-userid').value.trim();
      const email  = document.getElementById('input-email').value.trim();
      const secret = document.getElementById('input-secret').value.trim();

      if (!userId) { alert('Please enter a User ID.'); return; }
      if (!secret) { alert('Please enter your JWT Secret.'); return; }

      const jwtPayload = {
        sub: userId,
        iat: Math.floor(Date.now() / 1000),
        plan: plan
      };
      if (email) jwtPayload.email = email;

      let jwt, userHash;
      try {
        [jwt, userHash] = await Promise.all([
          generateJWT(secret, jwtPayload),
          generateUserHash(secret, userId)
        ]);
      } catch (e) {
        showOutput(plan, null, null, 'Error: ' + e.message);
        return;
      }

      window.Intercom('shutdown');

      window.intercomSettings = {
        api_base: "https://api-iam.eu.intercom.io",
        app_id: "j3ouceg3",
        user_id: userId,
        user_hash: userHash,
        plan: plan
      };
      if (email) window.intercomSettings.email = email;

      window.Intercom('boot', window.intercomSettings);

      showOutput(plan, jwt, userHash, 'Intercom re-initialised with ' + plan.toUpperCase() + ' plan.');
    }

    function showOutput(plan, jwt, userHash, statusMsg) {
      document.getElementById('jwt-output').style.display = 'block';
      const badge = document.getElementById('plan-badge');
      badge.textContent = plan.charAt(0).toUpperCase() + plan.slice(1);
      badge.className = 'badge ' + plan;
      document.getElementById('jwt-display').textContent = jwt || '—';
      document.getElementById('hash-display').textContent = userHash || '—';
      const status = document.getElementById('status-msg');
      status.textContent = statusMsg;
      status.className = jwt ? 'status' : 'status error';
    }

    function restartIntercom() {
      document.cookie = 'intercom-id-j3ouceg3=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
      for (var key in localStorage) {
        if (key.toLowerCase().indexOf('intercom') !== -1) localStorage.removeItem(key);
      }
      location.reload();
    }
  </script>

  <!-- Intercom widget: boot fresh (no reattach_activator) to avoid picking up stale sessions -->
  <script>
    window.intercomSettings = {
      api_base: "https://api-iam.eu.intercom.io",
      app_id: "j3ouceg3",
    };
  </script>

  <script>
    (function(){var w=window;var ic=w.Intercom;if(typeof ic==="function"){ic('shutdown');ic('boot',w.intercomSettings);}else{var d=document;var i=function(){i.c(arguments);};i.q=[];i.c=function(args){i.q.push(args);};w.Intercom=i;var l=function(){var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src='https://widget.intercom.io/widget/j3ouceg3';var x=d.getElementsByTagName('script')[0];x.parentNode.insertBefore(s,x);};if(document.readyState==='complete'){l();}else if(w.attachEvent){w.attachEvent('onload',l);}else{w.addEventListener('load',l,false);}}})();
  </script>

</body>
</html>
